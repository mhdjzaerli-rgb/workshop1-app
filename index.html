<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c1a0e">
<title>ÙˆØ±Ø´Ø© Ø§Ù„Ø®ÙŠØ§Ø·Ø©</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase loaded as regular scripts (NO type=module) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Amiri:wght@400;700&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#fdf8f2;--bg2:#f0e8d8;--surface:#fff;--surface2:#faf5ee;
  --border:#e2d0b8;--border2:#c8a87a;
  --ink:#2c1a0e;--ink2:#6b4c33;--ink3:#a07850;
  --gold:#b8892a;--gold2:#d4a843;--gold-light:#f5e6c0;
  --teal:#1a6b5c;--teal2:#1f8470;--teal-light:#d8f0ea;
  --rose:#8b2a3a;--rose-light:#f5dde1;
  --blue:#1a4a8b;--purple:#5a2a8b;
  --nav-h:64px;--top-h:60px;
  --safe-b:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;overflow:hidden;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--ink);}
[id^="screen-"]{display:none;flex-direction:column;height:100%;width:100%;}
#screen-loading{background:linear-gradient(135deg,#2c1a0e,#4a2c14);align-items:center;justify-content:center;gap:1.2rem;display:flex;}
.loading-icon{font-size:3.5rem;animation:pulse 1.2s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.loading-text{font-family:'Amiri',serif;font-size:1.3rem;color:#f5e6c0;}
.loading-sub{font-size:.78rem;color:var(--gold2);}
.loading-bar{width:160px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;}
.loading-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));animation:loadBar 1.8s ease-in-out infinite;}
@keyframes loadBar{0%{width:0%;margin-right:100%}50%{width:60%;margin-right:20%}100%{width:0%;margin-left:100%}}
#screen-home{background:linear-gradient(160deg,#2c1a0e 0%,#4a2c14 40%,#2c1a0e 100%);align-items:center;overflow-y:auto;padding:2rem 1.2rem calc(1.5rem + var(--safe-b));}
.home-logo{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin-bottom:2rem;}
.home-logo-icon{width:72px;height:72px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2.2rem;box-shadow:0 8px 30px rgba(184,137,42,.4);}
.home-logo-title{font-family:'Amiri',serif;font-size:1.6rem;color:#f5e6c0;font-weight:700;}
.home-logo-sub{font-size:.75rem;color:var(--gold2);}
.home-section-label{font-size:.75rem;font-weight:700;color:var(--gold2);letter-spacing:1.5px;margin-bottom:.75rem;align-self:flex-start;width:100%;max-width:420px;}
.worker-pick-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;width:100%;max-width:420px;margin-bottom:1.5rem;}
.worker-pick-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:1rem .75rem;display:flex;flex-direction:column;align-items:center;gap:.5rem;cursor:pointer;font-family:'Cairo',sans-serif;}
.worker-pick-btn:active{background:rgba(255,255,255,.22);transform:scale(.95);}
.wpb-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:white;}
.wpb-name{font-size:.88rem;font-weight:700;color:#f5e6c0;}
.home-divider{width:100%;max-width:420px;display:flex;align-items:center;gap:.75rem;margin-bottom:1.2rem;}
.home-divider-line{flex:1;height:1px;background:rgba(255,255,255,.12);}
.home-divider-text{font-size:.72rem;color:rgba(255,255,255,.4);}
.admin-login-btn{width:100%;max-width:420px;padding:.85rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:14px;font-family:'Cairo',sans-serif;font-size:.9rem;font-weight:700;color:rgba(255,255,255,.7);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;}
.admin-login-btn:active{background:rgba(0,0,0,.5);}
.admin-pw-sheet{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:500;}
.admin-pw-sheet.show{display:flex;}
.admin-pw-box{background:var(--surface);border-radius:22px 22px 0 0;width:100%;padding:1.5rem 1.5rem calc(1.5rem + var(--safe-b));}
.apw-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto .75rem;}
.apw-title{font-family:'Amiri',serif;font-size:1.15rem;font-weight:700;color:var(--gold);text-align:center;margin-bottom:1.2rem;}
.apw-icon{font-size:2.2rem;text-align:center;margin-bottom:.5rem;}
.apw-input{width:100%;padding:.85rem 1rem;background:var(--bg2);border:2px solid var(--border2);border-radius:13px;font-family:'Cairo',sans-serif;font-size:1.1rem;text-align:center;color:var(--ink);outline:none;letter-spacing:.15rem;margin-bottom:.5rem;}
.apw-input:focus{border-color:var(--gold);}
.apw-err{text-align:center;color:var(--rose);font-size:.82rem;font-weight:600;display:none;margin-bottom:.5rem;}
.apw-btns{display:flex;gap:.65rem;margin-top:.5rem;}
.apw-cancel{flex:1;padding:.75rem;background:var(--bg2);border:1px solid var(--border2);border-radius:12px;font-family:'Cairo',sans-serif;font-size:.88rem;font-weight:700;color:var(--ink2);cursor:pointer;}
.apw-submit{flex:2;padding:.75rem;background:linear-gradient(135deg,#2c1a0e,#4a2c14);border:1px solid var(--gold);border-radius:12px;font-family:'Cairo',sans-serif;font-size:.88rem;font-weight:700;color:#f5e6c0;cursor:pointer;}
#screen-workerApp{background:var(--bg);overflow:hidden;}
.worker-topbar{height:var(--top-h);background:linear-gradient(135deg,var(--teal),var(--teal2));display:flex;align-items:center;justify-content:space-between;padding:0 1rem;flex-shrink:0;box-shadow:0 2px 12px rgba(0,0,0,.25);}
.wt-info{display:flex;align-items:center;gap:.6rem;}
.wt-avatar{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:700;color:white;}
.wt-name{font-weight:700;font-size:1rem;color:white;}
.wt-role{font-size:.6rem;color:rgba(255,255,255,.75);}
.wt-stats{display:flex;gap:.5rem;align-items:center;}
.wt-stat{background:rgba(0,0,0,.2);border-radius:9px;padding:.3rem .6rem;text-align:center;}
.wt-stat-val{font-size:.95rem;font-weight:900;color:white;}
.wt-stat-lbl{font-size:.55rem;color:rgba(255,255,255,.7);}
.exit-btn{padding:.4rem .8rem;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:9px;color:white;font-family:'Cairo',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;}
.worker-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:1rem;}
.quick-add-card{margin:.85rem;background:var(--surface);border:2px solid var(--teal);border-radius:18px;overflow:hidden;box-shadow:0 4px 20px rgba(26,107,92,.15);}
.qac-header{background:linear-gradient(135deg,var(--teal),var(--teal2));padding:.75rem 1rem;display:flex;align-items:center;gap:.5rem;}
.qac-header-title{font-family:'Amiri',serif;font-size:1rem;color:white;font-weight:700;}
.qac-body{padding:1rem;}
.wform-group{margin-bottom:.85rem;}
.wform-group label{display:block;font-size:.72rem;font-weight:700;color:var(--ink2);margin-bottom:.35rem;}
.wform-group select,.wform-group input[type=date],.wform-group input[type=text]{width:100%;padding:.65rem .9rem;background:var(--bg2);border:1.5px solid var(--border2);border-radius:11px;font-family:'Cairo',sans-serif;font-size:1rem;color:var(--ink);outline:none;-webkit-appearance:none;}
.wform-group select:focus,.wform-group input:focus{border-color:var(--teal);}
.wform-grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
.qty-control{display:flex;align-items:center;gap:.75rem;}
.qty-btn{width:48px;height:48px;border:none;background:var(--teal-light);border-radius:12px;font-size:1.4rem;font-weight:700;color:var(--teal);cursor:pointer;}
.qty-btn:active{background:var(--teal);color:white;}
.qty-val{flex:1;text-align:center;font-size:1.6rem;font-weight:900;color:var(--ink);}
.worker-submit-btn{width:100%;padding:.9rem;background:linear-gradient(135deg,var(--teal),var(--teal2));border:none;border-radius:13px;font-family:'Cairo',sans-serif;font-size:1rem;font-weight:700;color:white;cursor:pointer;margin-top:.5rem;}
.worker-submit-btn:active{opacity:.88;}
.worker-recents-section{margin:.5rem .85rem .85rem;}
.wrs-title{font-family:'Amiri',serif;font-size:.95rem;font-weight:700;color:var(--ink);margin-bottom:.6rem;}
.wrec-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.75rem;margin-bottom:.55rem;}
.wrec-date{font-size:.7rem;color:var(--ink3);margin-bottom:.35rem;}
.wrec-tags{display:flex;gap:.4rem;flex-wrap:wrap;}
#screen-adminApp{background:var(--bg);overflow:hidden;}
.admin-topbar{height:var(--top-h);background:linear-gradient(135deg,#2c1a0e,#4a2c14);display:flex;align-items:center;justify-content:space-between;padding:0 1rem;border-bottom:2px solid var(--gold);flex-shrink:0;}
.at-brand{display:flex;align-items:center;gap:.55rem;}
.at-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1rem;}
.at-title{font-family:'Amiri',serif;font-size:1rem;font-weight:700;color:#f5e6c0;}
.at-sub{font-size:.58rem;color:var(--gold2);}
.at-actions{display:flex;align-items:center;gap:.4rem;}
.topbar-btn{width:34px;height:34px;border:none;background:rgba(255,255,255,.1);border-radius:9px;color:#f5e6c0;font-size:.88rem;cursor:pointer;}
.admin-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-b) + .5rem);}
.bottom-nav{height:calc(var(--nav-h) + var(--safe-b));padding-bottom:var(--safe-b);background:var(--surface);border-top:1px solid var(--border);display:flex;flex-shrink:0;}
.anav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.2rem;border:none;background:transparent;font-family:'Cairo',sans-serif;font-size:.62rem;font-weight:600;color:var(--ink3);cursor:pointer;padding:.4rem 0;}
.anav-btn .nav-icon{font-size:1.35rem;}
.anav-btn.active{color:var(--gold);}
.apage{display:none;}
.apage.active{display:block;}
.fab{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--nav-h) + var(--safe-b) + .8rem);z-index:40;width:56px;height:56px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:50%;font-size:1.6rem;color:white;box-shadow:0 4px 20px rgba(184,137,42,.5);cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mini-stats{display:flex;gap:.6rem;padding:.4rem 1rem .7rem;overflow-x:auto;scrollbar-width:none;}
.mini-stats::-webkit-scrollbar{display:none;}
.mini-stat{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.5rem .85rem;display:flex;align-items:center;gap:.5rem;flex-shrink:0;}
.mini-stat-icon{font-size:1.1rem;}
.mini-stat-val{font-size:1rem;font-weight:800;color:var(--ink);}
.mini-stat-lbl{font-size:.6rem;color:var(--ink3);}
.sec-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem .5rem;}
.sec-title{font-family:'Amiri',serif;font-size:1rem;font-weight:700;color:var(--ink);}
.sec-count{font-size:.7rem;color:var(--ink3);background:var(--bg2);padding:.15rem .5rem;border-radius:12px;}
.filter-scroll{display:flex;gap:.5rem;padding:.5rem 1rem;overflow-x:auto;scrollbar-width:none;}
.filter-scroll::-webkit-scrollbar{display:none;}
.filter-chip{display:flex;align-items:center;gap:.35rem;padding:.38rem .8rem;background:var(--surface);border:1px solid var(--border2);border-radius:20px;font-family:'Cairo',sans-serif;font-size:.75rem;font-weight:600;color:var(--ink2);cursor:pointer;white-space:nowrap;flex-shrink:0;}
.filter-chip.active-filter{background:var(--gold);color:white;border-color:var(--gold);}
.filter-chip select{border:none;background:transparent;font-family:'Cairo',sans-serif;font-size:.75rem;font-weight:600;color:inherit;outline:none;cursor:pointer;}
.filter-chip.active-filter select{color:white;}
.cards-list{display:flex;flex-direction:column;gap:.65rem;padding:0 .85rem .5rem;}
.rec-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:.85rem;}
.rec-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:.55rem;}
.rec-worker{display:flex;align-items:center;gap:.5rem;}
.worker-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:.82rem;font-weight:700;color:white;flex-shrink:0;}
.worker-name{font-weight:700;font-size:.92rem;}
.worker-date{font-size:.65rem;color:var(--ink3);}
.rec-qty{font-size:1.6rem;font-weight:900;color:var(--teal);line-height:1;}
.rec-qty-lbl{font-size:.6rem;color:var(--ink3);text-align:center;}
.rec-card-tags{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.6rem;}
.tag{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;border-radius:20px;font-size:.7rem;font-weight:700;}
.tag-model{background:var(--gold-light);color:var(--gold);border:1px solid rgba(184,137,42,.25);}
.tag-size{background:var(--teal-light);color:var(--teal);border:1px solid rgba(26,107,92,.25);}
.tag-color{border:1px solid rgba(0,0,0,.1);}
.cdot-sm{width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.15);flex-shrink:0;}
.rec-note{font-size:.73rem;color:var(--ink3);background:var(--bg2);border-radius:7px;padding:.3rem .6rem;margin-bottom:.6rem;}
.rec-actions{display:flex;gap:.5rem;}
.act-btn{flex:1;padding:.45rem;border:none;border-radius:9px;font-family:'Cairo',sans-serif;font-size:.75rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.3rem;}
.act-edit{background:var(--gold-light);color:var(--gold);border:1px solid rgba(184,137,42,.3);}
.act-del{background:var(--rose-light);color:var(--rose);border:1px solid rgba(139,42,58,.2);}
.empty{text-align:center;padding:3rem 2rem;color:var(--ink3);}
.empty-icon{font-size:3rem;margin-bottom:.5rem;opacity:.35;}
.summary-page{padding:.5rem .85rem;}
.worker-summary-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1rem;margin-bottom:.7rem;}
.ws-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.7rem;}
.ws-worker{display:flex;align-items:center;gap:.6rem;}
.ws-total{font-size:1.6rem;font-weight:900;color:var(--teal);}
.ws-total-lbl{font-size:.6rem;color:var(--ink3);text-align:center;}
.ws-models{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:.45rem;}
.ws-model-item{background:var(--bg2);border-radius:9px;padding:.4rem .5rem;text-align:center;}
.ws-model-name{font-size:.68rem;color:var(--ink2);font-weight:600;}
.ws-model-val{font-size:1rem;font-weight:800;color:var(--gold);}
.ws-bar{height:5px;background:var(--bg2);border-radius:10px;overflow:hidden;}
.ws-bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--teal),var(--teal2));}
.report-page{padding:.5rem .85rem 0;}
.report-month-nav{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:.65rem 1rem;margin-bottom:.85rem;}
.month-disp{font-family:'Amiri',serif;font-size:1.1rem;font-weight:700;color:var(--gold);}
.nav-arrow{width:36px;height:36px;border:1px solid var(--border2);background:var(--bg2);border-radius:9px;font-size:1rem;cursor:pointer;color:var(--ink2);}
.kpi-row{display:grid;grid-template-columns:1fr 1fr;gap:.65rem;margin-bottom:.85rem;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:.85rem;text-align:center;position:relative;overflow:hidden;}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.kpi-card.gold::before{background:linear-gradient(90deg,var(--gold),var(--gold2));}
.kpi-card.teal::before{background:linear-gradient(90deg,var(--teal),var(--teal2));}
.kpi-card.rose::before{background:linear-gradient(90deg,var(--rose),#c0392b);}
.kpi-card.blue::before{background:linear-gradient(90deg,var(--blue),#2980b9);}
.kpi-card.purple::before{background:linear-gradient(90deg,var(--purple),#7d3cff);}
.kpi-card.champion::before{background:linear-gradient(90deg,#f5c518,var(--gold));}
.kpi-card.champion{grid-column:1/-1;}
.kpi-icon2{font-size:1.3rem;margin-bottom:.2rem;}
.kpi-num{font-size:1.7rem;font-weight:900;}
.kpi-card.gold .kpi-num{color:var(--gold);}
.kpi-card.teal .kpi-num{color:var(--teal);}
.kpi-card.rose .kpi-num{color:var(--rose);}
.kpi-card.blue .kpi-num{color:var(--blue);}
.kpi-card.purple .kpi-num{color:var(--purple);}
.kpi-card.champion .kpi-num{color:var(--gold);font-size:1.1rem;}
.kpi-lbl{font-size:.65rem;color:var(--ink3);font-weight:600;margin-top:.15rem;}
.report-section{background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:.85rem;overflow:hidden;}
.rs-header{padding:.65rem 1rem;background:var(--surface2);border-bottom:1px solid var(--border);}
.rs-title{font-family:'Amiri',serif;font-size:.92rem;font-weight:700;color:var(--ink);}
.rs-body{padding:.85rem;}
.bar-chart{display:flex;flex-direction:column;gap:.6rem;}
.bar-row{display:flex;align-items:center;gap:.65rem;}
.bar-lbl{font-size:.75rem;font-weight:600;color:var(--ink2);min-width:62px;text-align:right;}
.bar-track{flex:1;background:var(--bg2);border-radius:20px;height:22px;overflow:hidden;}
.bar-fill{height:100%;border-radius:20px;display:flex;align-items:center;justify-content:flex-end;}
.bar-val{font-size:.7rem;font-weight:700;color:white;padding:0 .5rem;white-space:nowrap;}
.rank-list{display:flex;flex-direction:column;gap:.5rem;}
.rank-item{display:flex;align-items:center;gap:.7rem;background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:.6rem .8rem;}
.rank-num{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:900;flex-shrink:0;}
.r1{background:linear-gradient(135deg,#f5c518,#e6a817);color:#3d2200;}
.r2{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);color:#2c2c2c;}
.r3{background:linear-gradient(135deg,#cd7f32,#a56929);color:white;}
.rn{background:var(--bg2);color:var(--ink2);}
.rank-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:700;color:white;}
.rank-info{flex:1;}
.rank-name{font-weight:700;font-size:.86rem;}
.rank-sub{font-size:.65rem;color:var(--ink3);}
.rank-total{font-size:1.1rem;font-weight:900;color:var(--teal);}
.color-list{display:flex;flex-direction:column;gap:.45rem;}
.color-row{display:flex;align-items:center;gap:.6rem;}
.cswatch{width:16px;height:16px;border-radius:4px;border:1.5px solid rgba(0,0,0,.12);flex-shrink:0;}
.cname{font-size:.78rem;font-weight:600;color:var(--ink2);flex:1;}
.ctrack{flex:2;background:var(--bg2);border-radius:10px;height:9px;overflow:hidden;}
.cfill{height:100%;border-radius:10px;}
.ccnt{font-size:.72rem;font-weight:700;color:var(--ink);min-width:32px;text-align:left;}
.size-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.4rem;margin-bottom:.7rem;}
.size-item{background:var(--bg2);border-radius:9px;padding:.5rem .3rem;text-align:center;}
.size-lbl{font-size:.72rem;font-weight:700;color:var(--teal);}
.size-val{font-size:1rem;font-weight:900;}
.size-pct{font-size:.6rem;color:var(--ink3);}
.daily-cards{display:flex;flex-direction:column;gap:.5rem;}
.day-card{background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:.65rem .85rem;display:flex;align-items:center;gap:.8rem;}
.day-date{min-width:65px;}
.day-d{font-size:.82rem;font-weight:700;color:var(--ink);}
.day-dow{font-size:.62rem;color:var(--ink3);}
.day-bar-wrap{flex:1;}
.day-bar-track{background:var(--bg2);border-radius:10px;height:10px;margin-top:.25rem;overflow:hidden;}
.day-bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--teal),var(--teal2));}
.day-qty{font-size:1.1rem;font-weight:900;color:var(--teal);}
.peak-chip{background:var(--gold-light);color:var(--gold);border-radius:5px;padding:.1rem .35rem;font-size:.6rem;font-weight:700;}
.export-btn-full{width:100%;padding:.85rem;background:linear-gradient(135deg,var(--blue),#2060b0);border:none;border-radius:13px;font-family:'Cairo',sans-serif;font-size:.9rem;font-weight:700;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;margin-bottom:.85rem;}
.settings-page{padding:.5rem .85rem;}
.settings-section{background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:.85rem;overflow:hidden;}
.settings-section-title{padding:.65rem 1rem;background:var(--surface2);border-bottom:1px solid var(--border);font-family:'Amiri',serif;font-size:.92rem;font-weight:700;color:var(--ink);}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--border);}
.si-name{font-size:.88rem;font-weight:600;}
.si-sub{font-size:.68rem;color:var(--ink3);}
.si-del{width:32px;height:32px;border:none;background:var(--rose-light);color:var(--rose);border-radius:8px;font-size:.85rem;cursor:pointer;}
.add-item-row{padding:.7rem 1rem;}
.add-item-row input[type=text]{width:100%;padding:.55rem .85rem;background:var(--bg2);border:1px solid var(--border2);border-radius:9px;font-family:'Cairo',sans-serif;font-size:.88rem;color:var(--ink);outline:none;}
.add-item-btn{width:100%;margin-top:.4rem;padding:.55rem;background:var(--gold-light);border:1px solid rgba(184,137,42,.4);border-radius:9px;font-family:'Cairo',sans-serif;font-size:.82rem;font-weight:700;color:var(--gold);cursor:pointer;}
.overlay{position:fixed;inset:0;background:rgba(44,26,14,.55);display:none;align-items:flex-end;justify-content:center;z-index:200;}
.overlay.show{display:flex;}
.sheet{background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 0 calc(1rem + var(--safe-b));}
.sheet-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:.75rem auto .5rem;}
.sheet-title{font-family:'Amiri',serif;font-size:1.1rem;font-weight:700;color:var(--gold);padding:.3rem 1.2rem .8rem;border-bottom:1px solid var(--border);}
.sheet-body{padding:1rem 1.2rem;}
.form-group{margin-bottom:.9rem;}
.form-group label{display:block;font-size:.73rem;font-weight:700;color:var(--ink2);margin-bottom:.3rem;}
.form-group input,.form-group select{width:100%;padding:.65rem .9rem;background:var(--bg2);border:1.5px solid var(--border2);border-radius:11px;font-family:'Cairo',sans-serif;font-size:1rem;color:var(--ink);outline:none;-webkit-appearance:none;}
.form-group input:focus,.form-group select:focus{border-color:var(--gold);}
.form-grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
.color-picker{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.3rem;}
.cpick{display:flex;flex-direction:column;align-items:center;gap:.2rem;padding:.35rem .4rem;border-radius:9px;cursor:pointer;border:2px solid transparent;min-width:50px;font-size:.62rem;font-weight:600;color:var(--ink2);}
.cpick.active{border-color:var(--gold);background:var(--gold-light);}
.cpick .cdot{width:22px;height:22px;border-radius:50%;border:2px solid rgba(0,0,0,.15);}
.sheet-btns{display:flex;gap:.65rem;margin-top:1rem;}
.sbtn{flex:1;padding:.75rem;border:none;border-radius:12px;font-family:'Cairo',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;}
.sbtn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:white;}
.sbtn-ghost{background:var(--bg2);color:var(--ink2);border:1px solid var(--border2);}
.sbtn-danger{background:var(--rose);color:white;}
.confirm-icon{font-size:2.5rem;text-align:center;margin:.5rem 0;}
.confirm-msg{text-align:center;color:var(--ink2);font-size:.9rem;line-height:1.6;margin-bottom:1rem;}
.toast{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + .8rem);left:50%;transform:translateX(-50%) translateY(20px);background:var(--ink);color:white;border-radius:25px;padding:.65rem 1.4rem;font-size:.83rem;font-weight:600;transition:all .3s ease;z-index:900;opacity:0;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.success{background:var(--teal);}
.toast.error{background:var(--rose);}
.toast.info{background:var(--gold);}
</style>
</head>
<body>

<div id="screen-loading">
  <div class="loading-icon">ğŸ§µ</div>
  <div class="loading-text">ÙˆØ±Ø´Ø© Ø§Ù„Ø®ÙŠØ§Ø·Ø©</div>
  <div class="loading-sub">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<div id="screen-home">
  <div class="home-logo">
    <div class="home-logo-icon">ğŸ§µ</div>
    <div class="home-logo-title">ÙˆØ±Ø´Ø© Ø§Ù„Ø®ÙŠØ§Ø·Ø©</div>
    <div class="home-logo-sub">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù…Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØªØ§Ø¬Ùƒ</div>
  </div>
  <div class="home-section-label">ğŸ‘© Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª</div>
  <div class="worker-pick-grid" id="homeWorkerGrid"></div>
  <div class="home-divider">
    <div class="home-divider-line"></div>
    <div class="home-divider-text">Ø£Ùˆ</div>
    <div class="home-divider-line"></div>
  </div>
  <button class="admin-login-btn" onclick="openAdminLogin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
</div>

<div class="admin-pw-sheet" id="adminLoginSheet">
  <div class="admin-pw-box">
    <div class="apw-handle"></div>
    <div class="apw-icon">ğŸ”</div>
    <div class="apw-title">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</div>
    <input class="apw-input" type="password" id="adminPw" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="off" onkeydown="if(event.key==='Enter')tryAdminLogin()">
    <div class="apw-err" id="adminPwErr">âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
    <div class="apw-btns">
      <button class="apw-cancel" onclick="closeAdminLogin()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="apw-submit" onclick="tryAdminLogin()">ğŸ”“ Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>
</div>

<div id="screen-workerApp">
  <div class="worker-topbar">
    <div class="wt-info">
      <div class="wt-avatar" id="workerAvatar">ØŸ</div>
      <div>
        <div class="wt-name" id="workerName">â€”</div>
        <div class="wt-role">Ù…ÙˆØ¸ÙØ© Ø¥Ù†ØªØ§Ø¬</div>
      </div>
    </div>
    <div class="wt-stats">
      <div class="wt-stat"><div class="wt-stat-val" id="workerTodayQty">0</div><div class="wt-stat-lbl">Ø§Ù„ÙŠÙˆÙ…</div></div>
      <div class="wt-stat"><div class="wt-stat-val" id="workerTotalQty">0</div><div class="wt-stat-lbl">Ø§Ù„ÙƒÙ„</div></div>
      <button class="exit-btn" onclick="goHome()">â† Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  <div class="worker-scroll">
    <div class="quick-add-card">
      <div class="qac-header"><span>â•</span><div class="qac-header-title">ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØªØ§Ø¬ Ø¬Ø¯ÙŠØ¯</div></div>
      <div class="qac-body">
        <div class="wform-grid2">
          <div class="wform-group"><label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ *</label><select id="wf_model"></select></div>
          <div class="wform-group"><label>Ø§Ù„Ù…Ù‚Ø§Ø³ *</label>
            <select id="wf_size"><option>M</option><option>L</option><option selected>XL</option><option>XXL</option><option>3XL</option></select>
          </div>
        </div>
        <div class="wform-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" id="wf_date"></div>
        <div class="wform-group">
          <label>Ø§Ù„Ø¹Ø¯Ø¯ *</label>
          <div class="qty-control">
            <button class="qty-btn" onclick="changeWQty(-1)">âˆ’</button>
            <div class="qty-val" id="wQtyDisplay">1</div>
            <button class="qty-btn" onclick="changeWQty(1)">+</button>
          </div>
          <input type="hidden" id="wf_qty" value="1">
        </div>
        <div class="wform-group"><label>Ø§Ù„Ù„ÙˆÙ† *</label><div class="color-picker" id="wColorPicker"></div><input type="hidden" id="wf_color"></div>
        <div class="wform-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" id="wf_note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ..."></div>
        <button class="worker-submit-btn" onclick="workerSave()">âœ… Ø­ÙØ¸ Ø§Ù„Ø¥Ù†ØªØ§Ø¬</button>
      </div>
    </div>
    <div class="worker-recents-section">
      <div class="wrs-title">ğŸ• Ø¢Ø®Ø± Ø³Ø¬Ù„Ø§ØªÙƒ</div>
      <div id="workerRecentsList"></div>
    </div>
  </div>
</div>

<div id="screen-adminApp">
  <div class="admin-topbar">
    <div class="at-brand">
      <div class="at-icon">ğŸ§µ</div>
      <div><div class="at-title">ÙˆØ±Ø´Ø© Ø§Ù„Ø®ÙŠØ§Ø·Ø©</div><div class="at-sub">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</div></div>
    </div>
    <div class="at-actions">
      <span id="syncBadge" style="font-size:1rem">â˜ï¸</span>
      <button class="topbar-btn" onclick="exportXLSX()">ğŸ“Š</button>
      <button class="topbar-btn" onclick="adminLogout()">ğŸšª</button>
    </div>
  </div>
  <div class="admin-scroll" id="adminScroll" data-page="records">
    <div class="apage active" id="apage-records">
      <div id="adminMiniStats"></div>
      <div class="filter-scroll" id="adminFilterBar"></div>
      <div class="sec-header">
        <div class="sec-title">ğŸª¡ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div>
        <span class="sec-count" id="adminRecCount">0</span>
      </div>
      <div class="cards-list" id="adminCardsList"></div>
      <div class="empty" id="adminEmptyState" style="display:none"><div class="empty-icon">ğŸ§µ</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p></div>
    </div>
    <div class="apage" id="apage-summary">
      <div class="sec-header" style="padding-top:.85rem"><div class="sec-title">ğŸ“‹ Ù…Ù„Ø®Øµ ÙƒÙ„ Ù…ÙˆØ¸ÙØ©</div></div>
      <div class="summary-page" id="summaryPage"></div>
    </div>
    <div class="apage" id="apage-report"><div class="report-page" id="reportPage"></div></div>
    <div class="apage" id="apage-settings">
      <div class="sec-header" style="padding-top:.85rem"><div class="sec-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div></div>
      <div class="settings-page" id="settingsPage"></div>
    </div>
  </div>
  <button class="fab" id="afab" onclick="openAddRecord()">+</button>
  <nav class="bottom-nav">
    <button class="anav-btn active" id="anav-records" onclick="showAdminPage('records')"><span class="nav-icon">ğŸª¡</span>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
    <button class="anav-btn" id="anav-summary" onclick="showAdminPage('summary')"><span class="nav-icon">ğŸ“‹</span>Ø§Ù„Ù…Ù„Ø®Øµ</button>
    <button class="anav-btn" id="anav-report" onclick="showAdminPage('report')"><span class="nav-icon">ğŸ“…</span>Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    <button class="anav-btn" id="anav-settings" onclick="showAdminPage('settings')"><span class="nav-icon">âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </nav>
</div>

<div class="overlay" id="recordOverlay" onclick="if(event.target===this)closeSheet('recordOverlay')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="recordSheetTitle">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¥Ù†ØªØ§Ø¬</div>
    <div class="sheet-body">
      <div class="form-grid2">
        <div class="form-group"><label>Ø§Ù„Ù…ÙˆØ¸ÙØ© *</label><select id="r_worker"></select></div>
        <div class="form-group"><label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ *</label><select id="r_model"></select></div>
      </div>
      <div class="form-grid2">
        <div class="form-group"><label>Ø§Ù„Ù…Ù‚Ø§Ø³ *</label><select id="r_size"><option>M</option><option>L</option><option selected>XL</option><option>XXL</option><option>3XL</option></select></div>
        <div class="form-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" id="r_date"></div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¹Ø¯Ø¯ *</label>
        <div class="qty-control">
          <button class="qty-btn" onclick="changeQty(-1)">âˆ’</button>
          <div class="qty-val" id="qtyDisplay">1</div>
          <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>
        <input type="hidden" id="r_qty" value="1">
      </div>
      <div class="form-group"><label>Ø§Ù„Ù„ÙˆÙ† *</label><div class="color-picker" id="colorPicker"></div><input type="hidden" id="r_color"></div>
      <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" id="r_note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ..."></div>
      <div class="sheet-btns">
        <button class="sbtn sbtn-ghost" onclick="closeSheet('recordOverlay')">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="sbtn sbtn-gold" onclick="saveRecord()">ğŸ’¾ Ø­ÙØ¸</button>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="deleteOverlay" onclick="if(event.target===this)closeSheet('deleteOverlay')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" style="color:var(--rose)">ğŸ—‘ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</div>
    <div class="sheet-body">
      <div class="confirm-icon">âš ï¸</div>
      <p class="confirm-msg">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ<br><strong>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.</strong></p>
      <div class="sheet-btns">
        <button class="sbtn sbtn-ghost" onclick="closeSheet('deleteOverlay')">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="sbtn sbtn-danger" onclick="confirmDelete()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€” ØºÙŠÙ‘Ø± Ù‡Ù†Ø§ ÙÙ‚Ø·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var FIREBASE_CONFIG = {
  apiKey:            "AIzaSyC_fQFMqg5-ZVL3oSdzDt-DQ_aDdfFmC60",
  authDomain:        "workshop1-4f14a.firebaseapp.com",
  projectId:         "workshop1-4f14a",
  storageBucket:     "workshop1-4f14a.firebasestorage.app",
  messagingSenderId: "175989367938",
  appId:             "1:175989367938:web:8afdfbc19c1ac71d55809b"
};
var ADMIN_PASSWORD = "admin1234";
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var DEFAULT_WORKERS = ['Ù†Ø§Ø±ÙŠÙ…Ø§Ù†','Ù…ÙŠÙ†Ø§','Ø´Ø§Ù‡ÙŠÙ†Ø§Ø²','Ø³ÙˆÙŠÙƒÙŠ'];
var DEFAULT_MODELS  = ['ÙƒÙ†ÙØ©','Ù…Ø¹ÙŠÙ†Ø§Øª','Ù…Ø±Ø¨Ø¹Ø§Øª','ØºØ§Ù„ÙˆÙ†','ÙƒÙˆÙ„ÙÙŠ'];
var DEFAULT_COLORS  = [
  {name:'Ø§Ø­Ù…Ø±',hex:'#c0392b'},{name:'Ù…ÙˆÙ',hex:'#9b59b6'},{name:'Ù…ÙŠÙ„ÙƒØ§',hex:'#d7bde2'},
  {name:'Ø²ÙŠØªÙŠ',hex:'#6b8e23'},{name:'Ø¨Ù„ÙˆÙ†ÙˆÙŠ',hex:'#5dade2'},{name:'ØºØ±ÙˆÙ†Ø§',hex:'#8e1515'},
  {name:'Ø¨ÙŠØ³ØªØ§Ø´',hex:'#a8d8a8'},{name:'ÙÙŠØ±Ø¯Ùˆ',hex:'#27ae60'},{name:'ØªØ±ÙƒÙˆØ§Ø²',hex:'#1abc9c'},
  {name:'Ø¨ÙŠØ¬',hex:'#d4b896'},{name:'Ø²Ù‡Ø±',hex:'#f1948a'},{name:'Ø§Ø²Ø±Ù‚',hex:'#2980b9'}
];
var AM=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
var AD=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
var MC=['#b8892a','#1a6b5c','#8b2a3a','#1a4a8b','#5a2a8b','#2c7a5c','#7a5c2c','#5c2c7a'];

var workers=[], models=[], colors=[], records=[];
var isAdmin=false, currentWorker=null;
var editingId=null, deletingId=null, selColor='', wSelColor='';
var filtW='',filtM='',filtC='',filtS='',filtDate='';
var rYear=new Date().getFullYear(), rMonth=new Date().getMonth();
var curQty=1, wCurQty=1;
var TODAY = new Date().toISOString().split('T')[0];
var db = null;

// â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setScreen(name) {
  ['loading','home','workerApp','adminApp'].forEach(function(s){
    var el = document.getElementById('screen-'+s);
    if(el){ el.style.display='none'; el.style.flexDirection=''; }
  });
  var t = document.getElementById('screen-'+name);
  if(t){
    t.style.display='flex';
    t.style.flexDirection='column';
    if(name==='home') t.style.flexDirection='column';
  }
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type) {
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast '+(type||'info')+' show';
  setTimeout(function(){t.classList.remove('show');},3000);
}

// â”€â”€ Sync badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncBadge(state) {
  var el=document.getElementById('syncBadge');
  if(!el) return;
  var map={ok:'â˜ï¸',syncing:'â³',err:'âš ï¸'};
  el.textContent = map[state]||'â˜ï¸';
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp() {
  workers = DEFAULT_WORKERS.slice();
  models  = DEFAULT_MODELS.slice();
  colors  = DEFAULT_COLORS.map(function(c){return {name:c.name,hex:c.hex};});

  setScreen('loading');

  // Timeout fallback â€” ÙŠÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†Ù Ø­ØªÙ‰ Ù„Ùˆ Firebase Ø¨Ø·ÙŠØ¡
  var tid = setTimeout(function(){
    toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ Ù…Ø¤Ù‚Øª','error');
    var savedSession = localStorage.getItem('ws_session');
    var savedWorker  = localStorage.getItem('ws_worker');
    if(savedSession === 'admin') {
      isAdmin=true; setScreen('adminApp'); showAdminPage('records'); refreshAdmin();
    } else if(savedSession === 'worker' && savedWorker) {
      enterWorker(savedWorker);
    } else {
      setScreen('home'); renderHome();
    }
  }, 8000);

  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();

    // Test connection
    db.collection('settings').doc('workshop_config').get()
      .then(function(snap){
        clearTimeout(tid);
        if(!snap.exists){
          return db.collection('settings').doc('workshop_config').set({
            workers: DEFAULT_WORKERS, models: DEFAULT_MODELS, colors: DEFAULT_COLORS
          });
        } else {
          var d = snap.data();
          workers = d.workers || DEFAULT_WORKERS.slice();
          models  = d.models  || DEFAULT_MODELS.slice();
          colors  = d.colors  || DEFAULT_COLORS.map(function(c){return {name:c.name,hex:c.hex};});
        }
      })
      .then(function(){
        // Live listeners
        db.collection('settings').doc('workshop_config').onSnapshot(function(snap){
          if(!snap.exists) return;
          var d=snap.data();
          workers=d.workers||[]; models=d.models||[]; colors=d.colors||[];
          if(isAdmin) refreshAdmin(); else renderHome();
        });
        db.collection('records').onSnapshot(function(snap){
          records = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
          records.sort(function(a,b){ return b.date.localeCompare(a.date); });
          syncBadge('ok');
          if(isAdmin) refreshAdmin();
          else if(currentWorker) renderWorkerRecents();
        });
        // â”€â”€ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© â”€â”€
        var savedSession = localStorage.getItem('ws_session');
        var savedWorker  = localStorage.getItem('ws_worker');
        if(savedSession === 'admin') {
          isAdmin=true; currentWorker=null;
          setScreen('adminApp');
          showAdminPage('records');
          refreshAdmin();
          syncBadge('ok');
        } else if(savedSession === 'worker' && savedWorker) {
          enterWorker(savedWorker);
        } else {
          setScreen('home');
          renderHome();
        }
      })
      .catch(function(e){
        clearTimeout(tid);
        console.error('Firestore error:',e);
        toast('Ø®Ø·Ø£ Firebase: '+e.code,'error');
        setScreen('home');
        renderHome();
      });
  } catch(e) {
    clearTimeout(tid);
    console.error('Init error:',e);
    toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©','error');
    setScreen('home');
    renderHome();
  }
}

// â”€â”€ Home â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHome() {
  var g = document.getElementById('homeWorkerGrid');
  if(!g) return;
  g.innerHTML = workers.map(function(w){
    return '<button class="worker-pick-btn" onclick="enterWorker(\''+w+'\')">'+
      '<div class="wpb-avatar">'+w.charAt(0)+'</div>'+
      '<div class="wpb-name">'+w+'</div></button>';
  }).join('');
}

function openAdminLogin() {
  document.getElementById('adminLoginSheet').classList.add('show');
  setTimeout(function(){document.getElementById('adminPw').focus();},200);
}
function closeAdminLogin() {
  document.getElementById('adminLoginSheet').classList.remove('show');
  document.getElementById('adminPw').value='';
}
function tryAdminLogin() {
  var pw = document.getElementById('adminPw').value;
  if(pw === ADMIN_PASSWORD) {
    isAdmin=true; currentWorker=null;
    localStorage.setItem('ws_session','admin');
    closeAdminLogin();
    setScreen('adminApp');
    showAdminPage('records');
    refreshAdmin();
    syncBadge('ok');
  } else {
    var err = document.getElementById('adminPwErr');
    err.style.display='block';
    document.getElementById('adminPw').value='';
    setTimeout(function(){err.style.display='none';},2500);
  }
}
function adminLogout() {
  isAdmin=false;
  localStorage.removeItem('ws_session');
  localStorage.removeItem('ws_worker');
  setScreen('home');
  renderHome();
}
function goHome() {
  currentWorker=null; isAdmin=false;
  localStorage.removeItem('ws_session');
  localStorage.removeItem('ws_worker');
  setScreen('home');
  renderHome();
}

// â”€â”€ Worker App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterWorker(name) {
  currentWorker=name;
  isAdmin=false;
  localStorage.setItem('ws_session','worker');
  localStorage.setItem('ws_worker', name);
  document.getElementById('workerAvatar').textContent=name.charAt(0);
  document.getElementById('workerName').textContent=name;
  setScreen('workerApp');
  renderWorkerHeader();
  renderWorkerForm();
  renderWorkerRecents();
}

function renderWorkerHeader() {
  var tr=records.filter(function(r){return r.worker===currentWorker&&r.date===TODAY;});
  var todayQ=tr.reduce(function(s,r){return s+r.qty;},0);
  var totalQ=records.filter(function(r){return r.worker===currentWorker;}).reduce(function(s,r){return s+r.qty;},0);
  document.getElementById('workerTodayQty').textContent=todayQ;
  document.getElementById('workerTotalQty').textContent=totalQ;
}

function renderWorkerForm() {
  var wm=document.getElementById('wf_model');
  if(wm) wm.innerHTML=models.map(function(m){return '<option>'+m+'</option>';}).join('');
  var wd=document.getElementById('wf_date');
  if(wd) wd.value=TODAY;
  wCurQty=1;
  document.getElementById('wQtyDisplay').textContent='1';
  document.getElementById('wf_qty').value='1';
  document.getElementById('wf_note').value='';
  buildWColorPicker();
}

function buildWColorPicker() {
  wSelColor='';
  document.getElementById('wColorPicker').innerHTML=colors.map(function(c){
    return '<div class="cpick" onclick="wPickColor(\''+c.name+'\')" id="wcp_'+c.name+'">'+
      '<div class="cdot" style="background:'+c.hex+'"></div><span>'+c.name+'</span></div>';
  }).join('');
  document.getElementById('wf_color').value='';
}

function wPickColor(n) {
  wSelColor=n;
  document.getElementById('wf_color').value=n;
  document.querySelectorAll('#wColorPicker .cpick').forEach(function(el){el.classList.remove('active');});
  var el=document.getElementById('wcp_'+n);
  if(el) el.classList.add('active');
}

function changeWQty(d) {
  wCurQty=Math.max(1,wCurQty+d);
  document.getElementById('wQtyDisplay').textContent=wCurQty;
  document.getElementById('wf_qty').value=wCurQty;
}

function workerSave() {
  var m=document.getElementById('wf_model').value;
  var s=document.getElementById('wf_size').value;
  var q=parseInt(document.getElementById('wf_qty').value)||0;
  var d=document.getElementById('wf_date').value;
  var n=document.getElementById('wf_note').value.trim();
  var c=document.getElementById('wf_color').value||wSelColor;
  if(!m||!s||q<1||!d||!c){toast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ†','error');return;}

  if(!db) {
    records.unshift({id:'L'+Date.now(),worker:currentWorker,model:m,size:s,color:c,qty:q,date:d,note:n});
    toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ '+q+' Ø¬Ø¨Ø© âœ“ (Ù…Ø­Ù„ÙŠ)','success');
    renderWorkerForm(); renderWorkerHeader(); renderWorkerRecents();
    return;
  }
  syncBadge('syncing');
  db.collection('records').add({worker:currentWorker,model:m,size:s,color:c,qty:q,date:d,note:n,createdAt:Date.now()})
    .then(function(){
      toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ '+q+' Ø¬Ø¨Ø© âœ“','success');
      renderWorkerForm(); renderWorkerHeader(); renderWorkerRecents();
      syncBadge('ok');
    }).catch(function(e){
      toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª','error');
      syncBadge('err');
    });
}

function renderWorkerRecents() {
  var el=document.getElementById('workerRecentsList');
  if(!el||!currentWorker) return;
  var myR=records.filter(function(r){return r.worker===currentWorker;}).slice(0,10);
  if(!myR.length){el.innerHTML='<div style="text-align:center;padding:1.5rem;color:var(--ink3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</div>';return;}
  el.innerHTML=myR.map(function(r){
    var hex=gch(r.color);
    return '<div class="wrec-card">'+
      '<div style="display:flex;justify-content:space-between;align-items:center">'+
      '<div><div class="wrec-date">'+r.date+'</div>'+
      '<div class="wrec-tags">'+
      '<span class="tag tag-model">ğŸ‘— '+r.model+'</span>'+
      '<span class="tag tag-size">ğŸ“ '+r.size+'</span>'+
      '<span class="tag tag-color" style="background:'+hex+'22;color:'+hex+';border:1px solid '+hex+'44">'+
      '<span class="cdot-sm" style="background:'+hex+'"></span>'+r.color+'</span></div>'+
      (r.note?'<div style="font-size:.7rem;color:var(--ink3);margin-top:.25rem">ğŸ“ '+r.note+'</div>':'')+'</div>'+
      '<div style="text-align:center;min-width:44px"><div style="font-size:1.5rem;font-weight:900;color:var(--teal)">'+r.qty+'</div><div style="font-size:.6rem;color:var(--ink3)">Ø¬Ø¨Ø©</div></div>'+
      '</div></div>';
  }).join('');
  renderWorkerHeader();
}

// â”€â”€ Admin App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAdminPage(n) {
  document.querySelectorAll('.apage').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.anav-btn').forEach(function(b){b.classList.remove('active');});
  document.getElementById('apage-'+n).classList.add('active');
  document.getElementById('anav-'+n).classList.add('active');
  document.getElementById('afab').style.display=n==='records'?'flex':'none';
  document.getElementById('adminScroll').dataset.page=n;
  document.getElementById('adminScroll').scrollTop=0;
  if(n==='summary') renderSummary();
  if(n==='report')  renderReport();
  if(n==='settings') renderSettings();
}

function refreshAdmin() {
  var cur=document.getElementById('adminScroll').dataset.page||'records';
  renderAdminFilterBar();
  applyFilters();
  if(cur==='summary') renderSummary();
  if(cur==='report')  renderReport();
  if(cur==='settings') renderSettings();
}

function applyFilters() {
  var fr=records.filter(function(r){
    return (!filtW||r.worker===filtW)&&(!filtM||r.model===filtM)&&(!filtC||r.color===filtC)&&(!filtS||r.size===filtS)&&(!filtDate||r.date===filtDate);
  });
  renderAdminCards(fr);
  renderMiniStats(fr);
}

function renderMiniStats(fr) {
  var total=fr.reduce(function(s,r){return s+r.qty;},0);
  var wm={};fr.forEach(function(r){wm[r.worker]=(wm[r.worker]||0)+r.qty;});
  var best=Object.entries(wm).sort(function(a,b){return b[1]-a[1];})[0];
  document.getElementById('adminMiniStats').innerHTML='<div class="mini-stats">'+
    '<div class="mini-stat"><div class="mini-stat-icon">ğŸ§µ</div><div><div class="mini-stat-val">'+total+'</div><div class="mini-stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¨Ø¨</div></div></div>'+
    '<div class="mini-stat"><div class="mini-stat-icon">ğŸ“‹</div><div><div class="mini-stat-val">'+fr.length+'</div><div class="mini-stat-lbl">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div></div></div>'+
    '<div class="mini-stat"><div class="mini-stat-icon">ğŸ‘©</div><div><div class="mini-stat-val">'+new Set(fr.map(function(r){return r.worker;})).size+'</div><div class="mini-stat-lbl">Ù…ÙˆØ¸ÙØ§Øª</div></div></div>'+
    (best?'<div class="mini-stat" style="border-color:var(--gold2)"><div class="mini-stat-icon">ğŸ†</div><div><div class="mini-stat-val" style="color:var(--gold);font-size:.85rem">'+best[0]+'</div><div class="mini-stat-lbl">'+best[1]+' Ø¬Ø¨Ø©</div></div></div>':'')+'</div>';
}

function renderAdminFilterBar() {
  document.getElementById('adminFilterBar').innerHTML=
    '<div class="filter-chip'+(filtW?' active-filter':'')+'">ğŸ‘© <select onchange="filtW=this.value;applyFilters()" style="max-width:70px"><option value="">Ø§Ù„ÙƒÙ„</option>'+workers.map(function(w){return '<option'+(w===filtW?' selected':'')+'>'+w+'</option>';}).join('')+'</select></div>'+
    '<div class="filter-chip'+(filtM?' active-filter':'')+'">ğŸ‘— <select onchange="filtM=this.value;applyFilters()" style="max-width:65px"><option value="">Ø§Ù„ÙƒÙ„</option>'+models.map(function(m){return '<option'+(m===filtM?' selected':'')+'>'+m+'</option>';}).join('')+'</select></div>'+
    '<div class="filter-chip'+(filtS?' active-filter':'')+'">ğŸ“ <select onchange="filtS=this.value;applyFilters()" style="max-width:55px"><option value="">Ø§Ù„ÙƒÙ„</option>'+['M','L','XL','XXL','3XL'].map(function(s){return '<option'+(s===filtS?' selected':'')+'>'+s+'</option>';}).join('')+'</select></div>'+
    '<div class="filter-chip'+(filtC?' active-filter':'')+'">ğŸ¨ <select onchange="filtC=this.value;applyFilters()" style="max-width:65px"><option value="">Ø§Ù„ÙƒÙ„</option>'+colors.map(function(c){return '<option value="'+c.name+'"'+(c.name===filtC?' selected':'')+'>'+c.name+'</option>';}).join('')+'</select></div>'+
    '<div class="filter-chip'+(filtDate?' active-filter':'')+'">ğŸ“… <input type="date" value="'+filtDate+'" onchange="filtDate=this.value;applyFilters();renderAdminFilterBar()" style="border:none;background:transparent;font-family:Cairo,sans-serif;font-size:.72rem;color:inherit;outline:none;cursor:pointer;width:110px"></div>'+
    '<div class="filter-chip" onclick="filtW=\'\';filtM=\'\';filtS=\'\';filtC=\'\';filtDate=\'\';applyFilters();renderAdminFilterBar()">âœ• Ù…Ø³Ø­</div>';
}

function renderAdminCards(fr) {
  var el=document.getElementById('adminCardsList'),em=document.getElementById('adminEmptyState');
  document.getElementById('adminRecCount').textContent=fr.length;
  if(!fr.length){el.innerHTML='';em.style.display='block';return;}
  em.style.display='none';
  el.innerHTML=fr.map(function(r){
    var hex=gch(r.color);
    return '<div class="rec-card">'+
      '<div class="rec-card-top"><div class="rec-worker">'+
      '<div class="worker-avatar">'+(r.worker||'ØŸ').charAt(0)+'</div>'+
      '<div><div class="worker-name">'+(r.worker||'â€”')+'</div><div class="worker-date">'+(r.date||'')+'</div></div></div>'+
      '<div style="text-align:center"><div class="rec-qty">'+r.qty+'</div><div class="rec-qty-lbl">Ø¬Ø¨Ø©</div></div></div>'+
      '<div class="rec-card-tags">'+
      '<span class="tag tag-model">ğŸ‘— '+r.model+'</span>'+
      '<span class="tag tag-size">ğŸ“ '+r.size+'</span>'+
      '<span class="tag tag-color" style="background:'+hex+'22;color:'+hex+';border:1px solid '+hex+'44">'+
      '<span class="cdot-sm" style="background:'+hex+'"></span>'+r.color+'</span></div>'+
      (r.note?'<div class="rec-note">ğŸ“ '+r.note+'</div>':'')+
      '<div class="rec-actions">'+
      '<button class="act-btn act-edit" onclick="openEdit(\''+r.id+'\')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>'+
      '<button class="act-btn act-del" onclick="openDel(\''+r.id+'\')">ğŸ—‘ï¸ Ø­Ø°Ù</button>'+
      '</div></div>';
  }).join('');
}

// Admin record form
function buildColorPicker(){
  document.getElementById('colorPicker').innerHTML=colors.map(function(c){
    return '<div class="cpick'+(selColor===c.name?' active':'')+'" onclick="pickColor(\''+c.name+'\')" id="cp_'+c.name+'">'+
      '<div class="cdot" style="background:'+c.hex+'"></div><span>'+c.name+'</span></div>';
  }).join('');
}
function pickColor(n){
  selColor=n; document.getElementById('r_color').value=n;
  document.querySelectorAll('#colorPicker .cpick').forEach(function(el){el.classList.remove('active');});
  var el=document.getElementById('cp_'+n); if(el) el.classList.add('active');
}
function changeQty(d){curQty=Math.max(1,curQty+d);document.getElementById('qtyDisplay').textContent=curQty;document.getElementById('r_qty').value=curQty;}

function openAddRecord(){
  editingId=null; selColor=''; curQty=1;
  document.getElementById('recordSheetTitle').textContent='â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¥Ù†ØªØ§Ø¬';
  document.getElementById('r_date').value=TODAY;
  document.getElementById('qtyDisplay').textContent='1';
  document.getElementById('r_qty').value='1';
  document.getElementById('r_note').value='';
  document.getElementById('r_worker').innerHTML=workers.map(function(w){return '<option>'+w+'</option>';}).join('');
  document.getElementById('r_model').innerHTML=models.map(function(m){return '<option>'+m+'</option>';}).join('');
  buildColorPicker();
  document.getElementById('recordOverlay').classList.add('show');
}
function openEdit(id){
  var rec=records.find(function(r){return r.id===id;}); if(!rec) return;
  editingId=id; selColor=rec.color; curQty=rec.qty;
  document.getElementById('recordSheetTitle').textContent='âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„';
  document.getElementById('r_worker').innerHTML=workers.map(function(w){return '<option>'+w+'</option>';}).join('');
  document.getElementById('r_model').innerHTML=models.map(function(m){return '<option>'+m+'</option>';}).join('');
  document.getElementById('r_worker').value=rec.worker;
  document.getElementById('r_model').value=rec.model;
  document.getElementById('r_size').value=rec.size;
  document.getElementById('r_date').value=rec.date;
  document.getElementById('qtyDisplay').textContent=rec.qty;
  document.getElementById('r_qty').value=rec.qty;
  document.getElementById('r_note').value=rec.note||'';
  buildColorPicker();
  document.getElementById('recordOverlay').classList.add('show');
}
function openDel(id){ deletingId=id; document.getElementById('deleteOverlay').classList.add('show'); }
function closeSheet(id){ document.getElementById(id).classList.remove('show'); }

function saveRecord(){
  var w=document.getElementById('r_worker').value,m=document.getElementById('r_model').value,
    s=document.getElementById('r_size').value,q=parseInt(document.getElementById('r_qty').value)||0,
    d=document.getElementById('r_date').value,n=document.getElementById('r_note').value.trim(),
    c=document.getElementById('r_color').value||selColor;
  if(!w||!m||!s||q<1||!d||!c){toast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ†','error');return;}
  if(!db){
    if(editingId){var i=records.findIndex(function(r){return r.id===editingId;});if(i>-1)records[i]={id:editingId,worker:w,model:m,size:s,color:c,qty:q,date:d,note:n};}
    else records.unshift({id:'L'+Date.now(),worker:w,model:m,size:s,color:c,qty:q,date:d,note:n});
    closeSheet('recordOverlay'); refreshAdmin(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ (Ù…Ø­Ù„ÙŠ)','success'); return;
  }
  syncBadge('syncing');
  var p = editingId ?
    db.collection('records').doc(editingId).update({worker:w,model:m,size:s,color:c,qty:q,date:d,note:n}) :
    db.collection('records').add({worker:w,model:m,size:s,color:c,qty:q,date:d,note:n,createdAt:Date.now()});
  p.then(function(){closeSheet('recordOverlay');toast(editingId?'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ“':'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“','success');syncBadge('ok');})
   .catch(function(){toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸','error');syncBadge('err');});
}

function confirmDelete(){
  if(!deletingId) return;
  if(!db){records=records.filter(function(r){return r.id!==deletingId;});closeSheet('deleteOverlay');refreshAdmin();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');return;}
  syncBadge('syncing');
  db.collection('records').doc(deletingId).delete()
    .then(function(){closeSheet('deleteOverlay');toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');syncBadge('ok');})
    .catch(function(){toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù','error');syncBadge('err');});
}

// Settings CRUD
function saveSettings(){
  if(!db) return;
  db.collection('settings').doc('workshop_config').set({workers:workers,models:models,colors:colors})
    .catch(function(){toast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª','error');});
}
function addWorker(){
  var n=document.getElementById('new_worker').value.trim();
  if(!n){toast('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù…','error');return;}
  if(workers.indexOf(n)>-1){toast('Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹','error');return;}
  workers.push(n); saveSettings(); document.getElementById('new_worker').value=''; renderSettings(); toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“','success');
}
function removeWorker(n){workers=workers.filter(function(w){return w!==n;});saveSettings();renderSettings();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');}
function addModel(){
  var n=document.getElementById('new_model').value.trim();
  if(!n){toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','error');return;}
  if(models.indexOf(n)>-1){toast('Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','error');return;}
  models.push(n); saveSettings(); document.getElementById('new_model').value=''; renderSettings(); toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“','success');
}
function removeModel(n){models=models.filter(function(m){return m!==n;});saveSettings();renderSettings();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');}
function addColor(){
  var n=document.getElementById('new_color_name').value.trim(),h=document.getElementById('new_color_hex').value;
  if(!n){toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†','error');return;}
  if(colors.find(function(c){return c.name===n;})){toast('Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','error');return;}
  colors.push({name:n,hex:h}); saveSettings(); document.getElementById('new_color_name').value=''; renderSettings(); toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“','success');
}
function removeColor(n){colors=colors.filter(function(c){return c.name!==n;});saveSettings();renderSettings();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');}

// â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSummary(){
  var am=Array.from(new Set(models.concat(records.map(function(r){return r.model;}))));
  var wt={};
  workers.forEach(function(w){wt[w]={total:0};am.forEach(function(m){wt[w][m]=0;});});
  records.forEach(function(r){
    if(!wt[r.worker])wt[r.worker]={total:0};
    if(wt[r.worker][r.model]===undefined)wt[r.worker][r.model]=0;
    wt[r.worker][r.model]+=r.qty;wt[r.worker].total+=r.qty;
  });
  var maxT=Math.max.apply(null,workers.map(function(w){return wt[w]?wt[w].total||0:0;}).concat([1]));
  document.getElementById('summaryPage').innerHTML=workers.map(function(w){
    var d=wt[w]||{},pct=Math.round((d.total||0)/maxT*100);
    return '<div class="worker-summary-card">'+
      '<div class="ws-header"><div class="ws-worker">'+
      '<div class="worker-avatar" style="width:38px;height:38px">'+w.charAt(0)+'</div>'+
      '<div><div style="font-weight:700;font-size:.95rem">'+w+'</div>'+
      '<div style="font-size:.68rem;color:var(--ink3)">'+records.filter(function(r){return r.worker===w;}).length+' Ø³Ø¬Ù„</div></div></div>'+
      '<div style="text-align:center"><div class="ws-total">'+(d.total||0)+'</div><div class="ws-total-lbl">Ø¬Ø¨Ø©</div></div></div>'+
      '<div class="ws-bar"><div class="ws-bar-fill" style="width:'+pct+'%"></div></div>'+
      '<div class="ws-models" style="margin-top:.7rem">'+
      am.filter(function(m){return d[m]>0;}).map(function(m){
        return '<div class="ws-model-item"><div class="ws-model-name">'+m+'</div><div class="ws-model-val">'+d[m]+'</div></div>';
      }).join('')+'</div></div>';
  }).join('');
}

// â”€â”€ Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReport(){
  var mr=records.filter(function(r){return r.date&&r.date.startsWith(rYear+'-'+String(rMonth+1).padStart(2,'0'));});
  var mn=AM[rMonth]+' '+rYear;
  var totalQ=mr.reduce(function(s,r){return s+r.qty;},0);
  var days=new Set(mr.map(function(r){return r.date;}));
  var avg=days.size?(totalQ/days.size).toFixed(1):0;
  var wm={};mr.forEach(function(r){wm[r.worker]=(wm[r.worker]||0)+r.qty;});
  var best=Object.entries(wm).sort(function(a,b){return b[1]-a[1];})[0];
  var html='<div class="report-month-nav">'+
    '<button class="nav-arrow" onclick="rMonth--;if(rMonth<0){rMonth=11;rYear--;}renderReport()">â—€</button>'+
    '<div class="month-disp">'+mn+'</div>'+
    '<button class="nav-arrow" onclick="rMonth++;if(rMonth>11){rMonth=0;rYear++;}renderReport()">â–¶</button></div>'+
    '<div class="kpi-row">'+
    '<div class="kpi-card gold"><div class="kpi-icon2">ğŸ§µ</div><div class="kpi-num">'+totalQ+'</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¨Ø¨</div></div>'+
    '<div class="kpi-card teal"><div class="kpi-icon2">ğŸ“‹</div><div class="kpi-num">'+mr.length+'</div><div class="kpi-lbl">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div></div>'+
    '<div class="kpi-card blue"><div class="kpi-icon2">ğŸ‘©</div><div class="kpi-num">'+new Set(mr.map(function(r){return r.worker;})).size+'</div><div class="kpi-lbl">Ù…ÙˆØ¸ÙØ§Øª Ù†Ø´Ø·Ø§Øª</div></div>'+
    '<div class="kpi-card rose"><div class="kpi-icon2">ğŸ“ˆ</div><div class="kpi-num">'+avg+'</div><div class="kpi-lbl">Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ</div></div>'+
    '<div class="kpi-card purple"><div class="kpi-icon2">ğŸ‘—</div><div class="kpi-num">'+new Set(mr.map(function(r){return r.model;})).size+'</div><div class="kpi-lbl">Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</div></div>'+
    '<div class="kpi-card gold"><div class="kpi-icon2">ğŸ“…</div><div class="kpi-num">'+days.size+'</div><div class="kpi-lbl">Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div></div>'+
    (best?'<div class="kpi-card champion"><div class="kpi-icon2">ğŸ†</div><div class="kpi-num">'+best[0]+' â€” '+best[1]+' Ø¬Ø¨Ø©</div><div class="kpi-lbl">Ø§Ù„Ù…ÙˆØ¸ÙØ© Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ù†ØªØ§Ø¬Ø§Ù‹</div></div>':'')+
    '</div>';
  var sorted=Object.entries(wm).sort(function(a,b){return b[1]-a[1];});
  var maxW=sorted[0]?sorted[0][1]:1;
  if(sorted.length){
    html+='<div class="report-section"><div class="rs-header"><span class="rs-title">ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª</span></div><div class="rs-body"><div class="rank-list">';
    sorted.forEach(function(entry,i){
      var w=entry[0],q=entry[1];
      var rc=i===0?'r1':i===1?'r2':i===2?'r3':'rn';
      var wr=mr.filter(function(r){return r.worker===w;});
      html+='<div class="rank-item"><div class="rank-num '+rc+'">'+(i+1)+'</div>'+
        '<div class="rank-av">'+w.charAt(0)+'</div>'+
        '<div class="rank-info"><div class="rank-name">'+w+'</div><div class="rank-sub">'+new Set(wr.map(function(r){return r.date;})).size+' ÙŠÙˆÙ… â€¢ '+wr.length+' Ø³Ø¬Ù„</div></div>'+
        '<div class="rank-total">'+q+'</div></div>';
    });
    html+='</div></div></div>';
    html+='<div class="report-section"><div class="rs-header"><span class="rs-title">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</span></div><div class="rs-body"><div class="bar-chart">';
    sorted.forEach(function(entry,i){
      var w=entry[0],q=entry[1],pct=Math.round(q/maxW*100);
      html+='<div class="bar-row"><div class="bar-lbl">'+w+'</div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%;background:'+MC[i%MC.length]+'"><span class="bar-val">'+q+'</span></div></div></div>';
    });
    html+='</div></div></div>';
  }
  var mm={};mr.forEach(function(r){mm[r.model]=(mm[r.model]||0)+r.qty;});
  var sM=Object.entries(mm).sort(function(a,b){return b[1]-a[1];});
  if(sM.length){
    var maxMM=sM[0][1];
    html+='<div class="report-section"><div class="rs-header"><span class="rs-title">ğŸ‘— Ø¥Ù†ØªØ§Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</span></div><div class="rs-body"><div class="bar-chart">';
    sM.forEach(function(entry,i){var m=entry[0],q=entry[1],pct=Math.round(q/maxMM*100);html+='<div class="bar-row"><div class="bar-lbl">'+m+'</div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%;background:'+MC[(i+2)%MC.length]+'"><span class="bar-val">'+q+'</span></div></div></div>';});
    html+='</div></div></div>';
  }
  if(!mr.length) html+='<div class="empty"><div class="empty-icon">ğŸ“…</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p></div>';
  html+='<button class="export-btn-full" onclick="exportMonthly()">ğŸ“Š ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± '+mn+'</button>';
  document.getElementById('reportPage').innerHTML=html;
}

// â”€â”€ Settings render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettings(){
  document.getElementById('settingsPage').innerHTML=
    '<div class="settings-section"><div class="settings-section-title">ğŸ‘© Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª</div>'+
    workers.map(function(w,i){return '<div class="settings-item"><div><div class="si-name">'+w+'</div><div class="si-sub">Ù…ÙˆØ¸ÙØ© #'+(i+1)+'</div></div><div><button class="si-del" onclick="removeWorker(\''+w+'\')">ğŸ—‘ï¸</button></div></div>';}).join('')+
    '<div class="add-item-row"><input type="text" id="new_worker" placeholder="Ø§Ø³Ù… Ù…ÙˆØ¸ÙØ© Ø¬Ø¯ÙŠØ¯Ø©..."><button class="add-item-btn" onclick="addWorker()">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙØ©</button></div></div>'+
    '<div class="settings-section"><div class="settings-section-title">ğŸ‘— Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</div>'+
    models.map(function(m,i){return '<div class="settings-item"><div><div class="si-name">'+m+'</div><div class="si-sub">Ù…ÙˆØ¯ÙŠÙ„ #'+(i+1)+'</div></div><div><button class="si-del" onclick="removeModel(\''+m+'\')">ğŸ—‘ï¸</button></div></div>';}).join('')+
    '<div class="add-item-row"><input type="text" id="new_model" placeholder="Ø§Ø³Ù… Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯..."><button class="add-item-btn" onclick="addModel()">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„</button></div></div>'+
    '<div class="settings-section"><div class="settings-section-title">ğŸ¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</div>'+
    colors.map(function(c){return '<div class="settings-item"><div style="display:flex;align-items:center;gap:.6rem"><div style="width:20px;height:20px;border-radius:5px;background:'+c.hex+'"></div><div class="si-name">'+c.name+'</div></div><div><button class="si-del" onclick="removeColor(\''+c.name+'\')">ğŸ—‘ï¸</button></div></div>';}).join('')+
    '<div class="add-item-row"><input type="text" id="new_color_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†..."><div style="display:flex;gap:.5rem;margin-top:.4rem"><input type="color" id="new_color_hex" value="#6699cc" style="width:48px;height:40px;border-radius:9px;border:1px solid var(--border2);padding:2px;cursor:pointer;"><button class="add-item-btn" style="flex:1;margin:0" onclick="addColor()">+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ†</button></div></div></div>'+
    '<div class="settings-section"><div class="settings-section-title">ğŸ“Š Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div><div style="padding:.85rem 1rem;display:flex;flex-direction:column;gap:.6rem">'+
    '<button class="export-btn-full" style="margin:0" onclick="exportXLSX()">ğŸ“Š ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Excel)</button>'+
    '<button class="export-btn-full" style="margin:0;background:linear-gradient(135deg,var(--teal),var(--teal2))" onclick="backupJSON()">ğŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© (JSON)</button>'+
    '<button class="export-btn-full" style="margin:0;background:linear-gradient(135deg,#555,#333)" onclick="triggerRestore()">ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>'+
    '<input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreJSON(this)">'+
    '<div style="font-size:.7rem;color:var(--ink3);text-align:center;padding-top:.2rem">âš ï¸ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³ØªØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>'+
    '</div></div>'+
    '<div class="settings-section"><div class="settings-section-title">ğŸ” ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø¯ÙŠØ±</div><div style="padding:.85rem 1rem;font-size:.8rem;color:var(--ink3)">Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŒ Ø¹Ø¯Ù‘Ù„ Ù‚ÙŠÙ…Ø© <code style="background:var(--bg2);padding:.1rem .35rem;border-radius:4px">ADMIN_PASSWORD</code> ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.</div></div>';
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gch(n){var c=colors.find(function(c){return c.name===n;});return c?c.hex:'#aaa';}

// â”€â”€ Backup / Restore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerRestore(){
  var el = document.getElementById('restoreInput');
  if(el) el.click();
}

function backupJSON(){
  var data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    workers: workers,
    models:  models,
    colors:  colors,
    records: records.map(function(r){
      return {worker:r.worker,model:r.model,size:r.size,color:r.color,qty:r.qty,date:r.date,note:r.note||'',createdAt:r.createdAt||0};
    })
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  var d    = new Date();
  a.href   = url;
  a.download = 'ÙˆØ±Ø´Ø©_Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_'+d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© âœ“','success');
}

function restoreJSON(input){
  var file = input.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(e){
    try {
      var data = JSON.parse(e.target.result);
      if(!data.records || !data.workers){toast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­','error');return;}
      if(!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.\n\nØ§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù: '+data.records.length+'\nØ§Ù„Ù…ÙˆØ¸ÙØ§Øª: '+data.workers.join('ØŒ '))){return;}
      if(!db){toast('ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Ø£ÙˆÙ„Ø§Ù‹','error');return;}
      toast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©...','info');
      syncBadge('syncing');
      // Save settings
      db.collection('settings').doc('workshop_config').set({
        workers: data.workers, models: data.models, colors: data.colors
      }).then(function(){
        // Delete existing records then re-add
        return db.collection('records').get();
      }).then(function(snap){
        var batch = db.batch();
        snap.docs.forEach(function(d){ batch.delete(d.ref); });
        return batch.commit();
      }).then(function(){
        // Add restored records in batches of 500
        var recs = data.records;
        var batches = [];
        for(var i=0; i<recs.length; i+=400){
          batches.push(recs.slice(i,i+400));
        }
        return batches.reduce(function(p, chunk){
          return p.then(function(){
            var b = db.batch();
            chunk.forEach(function(r){
              b.set(db.collection('records').doc(), r);
            });
            return b.commit();
          });
        }, Promise.resolve());
      }).then(function(){
        toast('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“ ('+data.records.length+' Ø³Ø¬Ù„)','success');
        syncBadge('ok');
      }).catch(function(err){
        toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©','error');
        syncBadge('err');
        console.error(err);
      });
    } catch(err){
      toast('Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­','error');
    }
  };
  reader.readAsText(file);
  input.value=''; // allow re-selecting same file
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportXLSX(){
  var wb=XLSX.utils.book_new();
  var am=Array.from(new Set(models.concat(records.map(function(r){return r.model;}))));
  var r1=[['#','Ø§Ù„Ù…ÙˆØ¸ÙØ©','Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','Ø§Ù„Ù…Ù‚Ø§Ø³','Ø§Ù„Ù„ÙˆÙ†','Ø§Ù„Ø¹Ø¯Ø¯','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ù…Ù„Ø§Ø­Ø¸Ø©']];
  records.forEach(function(r,i){r1.push([i+1,r.worker,r.model,r.size,r.color,r.qty,r.date,r.note||'']);});
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(r1),'Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
  var d=new Date();
  XLSX.writeFile(wb,'ÙˆØ±Ø´Ø©_Ø§Ù„Ø®ÙŠØ§Ø·Ø©_'+d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate()+'.xlsx');
  toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± ğŸ“Š','success');
}

function exportMonthly(){
  var mr=records.filter(function(r){return r.date&&r.date.startsWith(rYear+'-'+String(rMonth+1).padStart(2,'0'));});
  var mn=AM[rMonth]+' '+rYear;
  var wb=XLSX.utils.book_new();

  // â”€â”€ ÙˆØ±Ù‚Ø© 1: Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© â”€â”€
  var r1=[['#','Ø§Ù„Ù…ÙˆØ¸ÙØ©','Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','Ø§Ù„Ù…Ù‚Ø§Ø³','Ø§Ù„Ù„ÙˆÙ†','Ø§Ù„Ø¹Ø¯Ø¯','Ø§Ù„ØªØ§Ø±ÙŠØ®']];
  mr.forEach(function(r,i){r1.push([i+1,r.worker,r.model,r.size,r.color,r.qty,r.date]);});
  var ws1=XLSX.utils.aoa_to_sheet(r1);
  ws1['!cols']=[{wch:4},{wch:12},{wch:12},{wch:8},{wch:10},{wch:8},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws1,'Ø§Ù„Ø³Ø¬Ù„Ø§Øª');

  // â”€â”€ ÙˆØ±Ù‚Ø© 2: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥Ù†ØªØ§Ø¬ ÙƒÙ„ Ù…ÙˆØ¸ÙØ© â”€â”€
  var am=Array.from(new Set(mr.map(function(r){return r.model;})));
  var wt={};
  workers.forEach(function(w){wt[w]={total:0};am.forEach(function(m){wt[w][m]=0;});});
  mr.forEach(function(r){
    if(!wt[r.worker])wt[r.worker]={total:0};
    if(wt[r.worker][r.model]===undefined)wt[r.worker][r.model]=0;
    wt[r.worker][r.model]+=r.qty;
    wt[r.worker].total+=r.qty;
  });
  // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ø§Ù„Ù…ÙˆØ¸ÙØ© + Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  var r2=[['Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ â€” '+mn],['']];
  var header=['Ø§Ù„Ù…ÙˆØ¸ÙØ©'].concat(am).concat(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ']);
  r2.push(header);
  // Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù…ÙˆØ¸ÙØ©
  var grandTotal=0;
  var modelTotals={};am.forEach(function(m){modelTotals[m]=0;});
  workers.forEach(function(w){
    var wd=wt[w]||{total:0};
    var row=[w];
    am.forEach(function(m){row.push(wd[m]||0);modelTotals[m]+=(wd[m]||0);});
    row.push(wd.total||0);
    grandTotal+=wd.total||0;
    r2.push(row);
  });
  // ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
  var totalRow=['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ'];
  am.forEach(function(m){totalRow.push(modelTotals[m]||0);});
  totalRow.push(grandTotal);
  r2.push(['']);
  r2.push(totalRow);
  var ws2=XLSX.utils.aoa_to_sheet(r2);
  var cols=[{wch:14}];am.forEach(function(){cols.push({wch:10});});cols.push({wch:12});
  ws2['!cols']=cols;
  XLSX.utils.book_append_sheet(wb,ws2,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª');

  XLSX.writeFile(wb,'ØªÙ‚Ø±ÙŠØ±_'+mn.replace(' ','_')+'.xlsx');
  toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± ğŸ“Š','success');
}

// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function(){ initApp(); };
</script>
  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(() => console.log("Service Worker Registered"))
    .catch(err => console.error("SW Error", err));
}
</script>
</body>
</html>
